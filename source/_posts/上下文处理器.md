---
title: 上下文处理器
date: 2018-12-24 22:43:21
tags:
  - Django2.0
category: 学习笔记
---

上下文处理器是可以返回一些数据，在全局模板中都可以使用。比如用户登录的信息在很多页面都需要使用，不可能每个视图都去获取 session 信息。这个时候就可以使用上下文处理器。
<!-- more -->

## Django内置的上下文处理器
在 settings.py 中 TEMPLATES.OPTIONS.context_processors 中，有许多内置的上下文处理器。这些上下文处理器有如下作用
1、django.template.context_processors.debug
   增加一个 debug 和 sql_queries 变量。在模板中可以通过他来查看到一些数据库查询。
2、django.template.context_processors.request
   增加一个 request 变量。这个 request 变量也就是在视图函数只能的第一个参数。
   在模板中也可以直接使用这个变量。
3、django.template.context_processors.auth
   Django 内置的用户系统，这个上下文处理器会增加一个 user 对象。
4、django.template.context_processors.messages
   增加一个 messages 变量。可以利用这变量将错误消息放入其中。然后在模板中使用。
   ，示例如下
```
# views.py
from django.contrib import messages

# 将错误消息放入 messages中
errors = form.get_error()
for error in errors:
    messages.info(request, error)

# template/xxx.html
# 在模板中显示错误消息
{% for message in messages %}
    {{ message }}
{% endfor %}
```
5、django.template.context_processors.media
在模板中可以读取 MEDIA_URL 。比如想要在模板中使用上传的文件，那么这时候就需要使用 settings.py 中设置的 MEDIA_URL 来拼接 url。示例代码如下
```
<img src="{{ MEDIA_URL }}{{文件相对路径}}"" alt="">
```
6、django.template.context_processors.static
在模板中可以使用 STATIC_URL。也就是在模板中不用每次都 load static 标签
可以直接使用。
7、django.template.context_processors.csrf
在模板中可以使用 csrf_token 变量来生成一个 csrf_token。在模板中的每个 form 标签的地方都要做 csrf 验证。如果不在 form 表单中。
```
# 在 form 表单中
{% csrf_token %}

# 不在 form 表单中
{{ csrf_token }}
```

## 自定义shangx文处理器
现有需要如下，每个页面都需要判断用户是否登录，不可能在每个视图中写一个判断函数。这时候就需要一个上下文处理器，来获取 session 或者 cookie 中是否有 user信息。如果有就判定用户已经登录，没有则没有登录。在模板中就只需要调用这个上下文就可判断了。
1、根据这个上下文处理器是属于哪个app，然后在这个app中创建一个文件专门用来存储上下文处理器。比如context_processors.py。或者是也可以专门创建一个Python包，用来存储所有的上下文处理器。
2、在定义的上下文处理器文件中，定义一个函数，这个函数只有一个request参数。这个函数中处理完自己的逻辑后，把需要返回给模板的数据，通过字典的形式返回。如果不需要返回任何数据，那么也必须返回一个空的字典
```
# front/context_processors.py
def front_user(request):
    user_id = request.session.get('user_id')
    context = {}
    if user_id:
        try:
            user = User.objects.get(pk=user_id)
            context['front_user'] = user
        except:
            pass
    return context
```
3、然后在 settings.TEMPLATES.OPTIONS.context_processors 中写上这个上下文处理器的路径。
```
# setting.py
'front.context_processors.front_user'
```
4、在模板中就可以直接使用了。
```
# base.html
{% if front_user %}
    <li><a href="#">{{ front_user.username }}</a></li>
{% else %}
    <li><a href="{% url 'signin' %}">登录</a></li>
    <li><a href="{% url 'signup' %}">注册</a></li>
{% endif %}
```
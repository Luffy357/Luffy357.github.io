---
title: 文件上传
date: 2018-12-18 23:42:42
tags:
  - Django2.0
category: 学习笔记
---

要实现上传文件，前端必须有特定的上传文件代码，Django 只需要对这个文件做保存。
<!-- more -->

## 前端代码
1、在前端中，使用 form 标签，必须指定 enctype="multipart/form-data"
2、在 form 标签中添加一个 input 标签，并且 type="file"。
```
<form action="" method="post" enctype="multipart/form-data">
    <input type="file" name="myfile">
    <input type"submile" name='提交'>
</form>
```

## 后端代码
后端主要是接收文件，并存储文件。接收方法和 POST 的方法一样，只不过是通过 FILES 来实现。
```
# views.py
class IndexView(View):
    def post(request):
        myfiles = request.FILES.get('myfile')
        with open('somefile.txt', 'wb') as fp:
            for chunk in file.chunks():
                fp.write(ckunk)
        return HttpResponse("succes")
```

## 使用模型来处理上传的文件
在定义模型的时候，可以给存储文件的字段指定为 FielField，这 Field 可以传递一个 upload_to 参数，用来指定上传上来的文件保存在那里。如果要指定文件夹保存参数值为该文件夹路径。
```
# models.py
class Article(models.Model):
    title = models.CharFiels(max_length=100)
    contetn = models.TextField()
    thumbnail = models.FileField(upload_to="%Y%m%d")

# views.py
class IndexView(View):
    def post(request):
        title = request.POST.get('title')
        content = request.POST.get('content')
        myfiles = request.FILES.get('myfile')
        article = Article.object.create(title=tilte, content=content, thumbnail=myfiles)
        article.save
        return HttpResponse("succes")
```
%Y%m%d 将以年月日创建文件夹来保存不同时间上传的文件。

## 指定 MEDIA_ROOT 和 MEDIA_URL：
除了通过 upload_to 指定上传文件的目录，还可以用 MEDIA_ROOT，指定了 MEDIA_ROOT 就不需要指定 upload_to。如果同时指定了，那么 MEDIA_ROOT 指定的文件夹将包含 upload_to 指定文件夹。MEDIA_URL 指定要访问上传文件的路径
```
# settings.py
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')
MEDIA_URL = '/media/'
```

在 urls.py 添加 MEDIA_ROOT 目录下的访问路径
```
from djagno.conf.urls.static import static

urlptterns = [
    path('', views.index),
]+ static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
```

## 限制上传文件扩展名
因为是以模板的形式保存文就，如果要限制上传的文件类型。就需要用到表单验证。
首先通过 FileExtensionValidata 验证器对文件类型进行限制。
```
# models.py 
class Article(models.Model):
    title = models.CharField(max_length=100)
    content = models.TextField()
    thumbnial = models.FileField(upload_to='%Y%m%d', validators=[validators.FileExtensionValidator(['txt', 'pdf'])])

# forms.py
class ArticleForm(forms.ModelForm):
    class Meta:
        model = Article
        fields = "__all__"    
```

## 上传图片
上传图片和上文件是一样的，只不过把 FileField 改为 ImageField就行，并且 Django 会自动判断上传的图片是否符合格式要求。如果不是就会验证失败。
```
class Article(models.Model):
    title = models.CharField(max_length=100)
    content = models.TextField()
    thumbnail = models.ImageField(upload_to="%Y/%m/%d/")
```

虽然 Django 会自动验证图片是否合格，但还是要定义表单验证。
```
class MyForm(forms.ModelForm):
    class Meta:
        model = Article
        fields = "__all__"
```

注意: 使用 ImageField, 必须要先安装 Pillow 库：pip install pillow